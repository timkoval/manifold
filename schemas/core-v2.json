{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "manifold://core/v2",
  "title": "Manifold Core Schema v2",
  "description": "Extended schema supporting multiple node types with boundary enforcement",
  "type": "object",
  "properties": {
    "$schema": {
      "type": "string",
      "const": "manifold://core/v2",
      "description": "Schema identifier"
    },
    "manifold_id": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9-]*$",
      "description": "Unique manifold identifier (kebab-case)"
    },
    "boundaries": {
      "type": "object",
      "description": "Boundary definitions for this manifold",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "visibility": {
            "type": "string",
            "enum": ["public", "personal", "work", "company"],
            "description": "Boundary visibility level"
          },
          "description": {
            "type": "string",
            "description": "Human-readable boundary description"
          }
        },
        "required": ["visibility"],
        "additionalProperties": false
      }
    },
    "nodes": {
      "type": "array",
      "description": "Array of nodes in this manifold",
      "items": {
        "$ref": "#/$defs/node"
      }
    },
    "version": {
      "type": "integer",
      "default": 1,
      "description": "Manifold document version"
    }
  },
  "required": ["manifold_id", "boundaries", "nodes"],
  "additionalProperties": false,
  "$defs": {
    "node": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Unique node identifier"
        },
        "type": {
          "type": "string",
          "enum": ["project", "spec", "knowledge", "diary", "research"],
          "description": "Node type"
        },
        "boundary": {
          "type": "string",
          "description": "Boundary this node belongs to (must match a defined boundary)"
        },
        "title": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable title"
        },
        "content": {
          "type": "object",
          "description": "Type-specific content structure"
        },
        "links": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Links to other node IDs"
        },
        "history": {
          "$ref": "#/$defs/history",
          "description": "Change tracking history"
        },
        "embeddings": {
          "type": "object",
          "description": "Optional base64-encoded embeddings for semantic search"
        }
      },
      "required": ["id", "type", "boundary"],
      "additionalProperties": false
    },
    "project_content": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "description": "Project name"
        },
        "description": {
          "type": "string",
          "description": "Project description"
        },
        "requirements": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/requirement"
          }
        },
        "scenarios": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/scenario"
          }
        },
        "tasks": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/task"
          }
        },
        "decisions": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/decision"
          }
        },
        "workflow_stage": {
          "type": "string",
          "enum": ["requirements", "design", "tasks", "approval", "implemented"]
        }
      },
      "additionalProperties": false
    },
    "spec_content": {
      "type": "object",
      "properties": {
        "project_id": {
          "type": "string",
          "description": "Parent project ID"
        },
        "requirements": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/requirement"
          }
        },
        "tasks": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/task"
          }
        },
        "decisions": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/decision"
          }
        },
        "workflow_stage": {
          "type": "string",
          "enum": ["requirements", "design", "tasks", "approval", "implemented"]
        },
        "stages_completed": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["requirements", "design", "tasks", "approval", "implemented"]
          }
        }
      },
      "required": ["project_id"],
      "additionalProperties": false
    },
    "knowledge_content": {
      "type": "object",
      "properties": {
        "topic": {
          "type": "string",
          "description": "Knowledge topic"
        },
        "notes": {
          "type": "string",
          "description": "Notes in Markdown or JSON format"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "linked_specs": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Links to related spec IDs"
        }
      },
      "required": ["topic", "notes"],
      "additionalProperties": false
    },
    "diary_content": {
      "type": "object",
      "properties": {
        "date": {
          "type": "string",
          "format": "date",
          "description": "Entry date (YYYY-MM-DD)"
        },
        "reflection": {
          "type": "string",
          "description": "Diary reflection entry"
        },
        "linked_specs": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Links to related spec IDs"
        },
        "mood": {
          "type": "string",
          "enum": ["positive", "neutral", "negative"],
          "default": "neutral"
        }
      },
      "required": ["date", "reflection"],
      "additionalProperties": false
    },
    "research_content": {
      "type": "object",
      "properties": {
        "hub": {
          "type": "string",
          "description": "Research hub or area"
        },
        "entries": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/research_entry"
          }
        },
        "linked_specs": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Links to related spec IDs"
        }
      },
      "required": ["hub", "entries"],
      "additionalProperties": false
    },
    "research_entry": {
      "type": "object",
      "properties": {
        "source": {
          "type": "string",
          "description": "Source of research"
        },
        "summary": {
          "type": "string",
          "description": "Research summary"
        },
        "date": {
          "type": "string",
          "format": "date",
          "description": "Research date"
        },
        "url": {
          "type": "string",
          "format": "uri",
          "description": "Source URL (optional)"
        }
      },
      "required": ["source", "summary"],
      "additionalProperties": false
    },
    "requirement": {
      "type": "object",
      "required": ["id", "capability", "title", "shall"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^req-[0-9]+$"
        },
        "capability": {
          "type": "string",
          "description": "Capability this requirement belongs to"
        },
        "title": {
          "type": "string",
          "minLength": 1
        },
        "shall": {
          "type": "string",
          "minLength": 1,
          "description": "The SHALL/MUST statement"
        },
        "rationale": {
          "type": "string",
          "description": "Why this requirement exists"
        },
        "priority": {
          "type": "string",
          "enum": ["must", "should", "could", "wont"],
          "default": "should"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "scenarios": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/scenario"
          }
        }
      }
    },
    "scenario": {
      "type": "object",
      "required": ["id", "name", "given", "when", "then"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^sc-[0-9]+$"
        },
        "name": {
          "type": "string",
          "minLength": 1
        },
        "given": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Preconditions (array of strings)"
        },
        "when": {
          "type": "string",
          "description": "The trigger or action"
        },
        "then": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Expected outcomes (array of strings)"
        },
        "edge_cases": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Edge cases to consider"
        }
      }
    },
    "task": {
      "type": "object",
      "required": ["id", "requirement_ids", "title", "description", "status"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^task-[0-9]+$"
        },
        "requirement_ids": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^req-[0-9]+$"
          },
          "description": "Requirements this task implements"
        },
        "title": {
          "type": "string",
          "minLength": 1
        },
        "description": {
          "type": "string",
          "minLength": 1
        },
        "status": {
          "type": "string",
          "enum": ["pending", "in_progress", "completed", "blocked"]
        },
        "assignee": {
          "type": "string",
          "description": "Who is working on this"
        },
        "acceptance": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Acceptance criteria"
        }
      }
    },
    "decision": {
      "type": "object",
      "required": ["id", "title", "context", "decision", "rationale", "date"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^dec-[0-9]+$"
        },
        "title": {
          "type": "string",
          "minLength": 1
        },
        "context": {
          "type": "string",
          "description": "The problem or question"
        },
        "decision": {
          "type": "string",
          "description": "What was decided"
        },
        "rationale": {
          "type": "string",
          "description": "Why this decision was made"
        },
        "alternatives_rejected": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Other options considered"
        },
        "date": {
          "type": "string",
          "format": "date",
          "description": "When this decision was made"
        }
      }
    },
    "history": {
      "type": "object",
      "required": ["created_at", "updated_at"],
      "properties": {
        "created_at": {
          "type": "integer",
          "description": "Unix timestamp"
        },
        "updated_at": {
          "type": "integer",
          "description": "Unix timestamp"
        },
        "patches": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/patch_entry"
          }
        }
      }
    },
    "patch_entry": {
      "type": "object",
      "required": ["timestamp", "actor", "op", "path", "summary"],
      "properties": {
        "timestamp": {
          "type": "integer"
        },
        "actor": {
          "type": "string",
          "description": "User or agent who made the change"
        },
        "op": {
          "type": "string",
          "description": "JSON Patch operation type"
        },
        "path": {
          "type": "string",
          "description": "JSON Patch path"
        },
        "summary": {
          "type": "string",
          "description": "Human-readable summary of the change"
        }
      }
    }
  }
}
